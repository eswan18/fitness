# Fitness API â€“ Setup & Usage

## Overview

This API provides analysis and aggregation of your running data from two sources:
- **MapMyFitness**: Historical and treadmill runs (CSV export)
- **Strava**: Outdoor runs (via Strava API)

---

## 1. Prerequisites
- Python 3.13+ (recommended: [uv](https://github.com/astral-sh/uv))
- [Make](https://www.gnu.org/software/make/) (for convenience commands)
- Strava account (for outdoor run data)
- MapMyFitness CSV export (for historical/treadmill runs)

---

## 2. Environment Variables

Create a `.env` file in the `api/` directory with the following variables:

```env
# Required for Strava API integration
STRAVA_CLIENT_ID=your_strava_client_id
STRAVA_CLIENT_SECRET=your_strava_client_secret
STRAVA_REFRESH_TOKEN=your_strava_refresh_token

# Required for MapMyFitness data
MMF_DATAFILE=/absolute/path/to/your/mapmyfitness.csv

# Optional: Set the timezone for MMF data (default: America/Chicago)
MMF_TIMEZONE=America/Chicago
```

- **STRAVA_CLIENT_ID / SECRET / REFRESH_TOKEN**:  
  Get these from your Strava API application settings. The refresh token is obtained after the initial OAuth flow (the app will prompt you on first run).
- **MMF_DATAFILE**:  
  Path to your MapMyFitness CSV export (see below).
- **MMF_TIMEZONE**:  
  The timezone your MMF data was recorded in. Defaults to "America/Chicago" if not set.

---

## 3. Getting the Data

### MapMyFitness
- Download your data as CSV from:  
  https://www.mapmyfitness.com/workout/export/csv
- Save the file and set `MMF_DATAFILE` to its path.

### Strava
- The API will prompt you to authorize the app on first run if credentials are missing or expired.

---

## 4. Installing Dependencies

From the `api/` directory:

```sh
uv pip install -r requirements.txt
# or, if using pyproject.toml:
uv pip install
```

---

## 5. Starting the API Server

- **Development server (with auto-reload):**
  ```sh
  make dev
  # or
  uv run -m uvicorn fitness.app.app:app --reload
  ```

- **Production server:**
  ```sh
  make serve
  # or
  uv run -m uvicorn fitness.app.app:app
  ```

- The API will be available at `http://localhost:8000`.

---

## 6. API Documentation

- Interactive API docs (auto-generated by FastAPI) are available at:  
  `http://localhost:8000/docs`

---

## 7. Example: Quick Test

Fetch all runs:
```sh
curl "http://localhost:8000/runs"
```

Fetch metrics (see `/docs` for all endpoints):
```sh
curl "http://localhost:8000/metrics/mileage/by-shoe"
```

---

## 8. Testing

- **Unit tests only:**
  ```sh
  make test
  ```
- **All tests (including integration with Strava):**
  ```sh
  make all-test
  ```
  > Note: Integration tests require valid Strava credentials and may prompt for authorization.

- **Linting, formatting, and type checks:**
  ```sh
  make lint
  make format
  make ty
  ```
